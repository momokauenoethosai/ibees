<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Portrait Parts Picker (Cloud Run)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Meiryo, Arial, sans-serif; }
    body { margin: 24px; color: #111; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.04);}
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .thumb { width: 160px; display:flex; flex-direction: column; gap: 6px; align-items: center; }
    .thumb img { width: 160px; height: 160px; object-fit: contain; border: 1px solid #eee; border-radius: 8px; background: #fff; }
    .muted { color: #666; font-size: 12px; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #ddd; background: #111; color: #fff; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .bar { height: 8px; border-radius: 8px; background: #eee; overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: #4f46e5; transition: width .3s ease; }
    .status { margin-top: 12px; padding: 12px; border-radius: 8px; background: #f8f9fa; border: 1px solid #e9ecef; }
    .status.processing { background: #e3f2fd; border-color: #90caf9; }
    .status.completed { background: #e8f5e8; border-color: #a5d6a7; }
    .status.skipped { background: #fff3e0; border-color: #ffcc02; }
    .status.error { background: #ffebee; border-color: #ef5350; }
    .part-list { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .part-item { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f0f0f0; }
    .part-item.processing { background: #2196f3; color: white; }
    .part-item.completed { background: #4caf50; color: white; }
    .part-item.skipped { background: #ff9800; color: white; }
  </style>
</head>
<body>
  <h1>Portrait Parts Picker</h1>

  <div class="card">
    <form id="form">
      <input type="file" id="image" name="image" accept="image/*" required />
      <button type="submit" id="btn">åˆ†æé–‹å§‹</button>
    </form>
    <div class="bar" style="margin-top:12px;"><div id="prog"></div></div>
    <div class="muted" id="msg" style="margin-top:8px;">ç”»åƒã‚’é¸ã‚“ã§ã€Œåˆ†æé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="status-container" style="display:none;" class="status">
      <div id="current-status">æº–å‚™ä¸­...</div>
      <div class="part-list" id="part-list"></div>
    </div>
  </div>

  <div class="card" style="margin-top:24px;">
    <h2>çµæœ</h2>
    <div style="margin-bottom:12px;">
      <button id="compose-btn" style="display:none;" disabled>ãƒ‘ãƒ¼ãƒ„ã‚’åˆæˆã™ã‚‹</button>
    </div>
    <div id="result">
      <div class="muted">ã¾ã çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const prog = document.getElementById('prog');
    const result = document.getElementById('result');
    const statusContainer = document.getElementById('status-container');
    const currentStatus = document.getElementById('current-status');
    const partList = document.getElementById('part-list');
    const composeBtn = document.getElementById('compose-btn');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§åˆ†æçµæœã‚’ä¿æŒ
    let analysisResult = null;

    // ãƒ‘ãƒ¼ãƒ„ã®æ—¥æœ¬èªå
    const partNames = {
      hair: 'é«ªå‹', eye: 'ç›®', eyebrow: 'çœ‰æ¯›', nose: 'é¼»', mouth: 'å£',
      ear: 'è€³', outline: 'è¼ªéƒ­', acc: 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼', beard: 'ã²ã’', 
      glasses: 'ãƒ¡ã‚¬ãƒ', extras: 'ãã®ä»–', wrinkles: 'ã—ã‚'
    };

    // ãƒ‘ãƒ¼ãƒ„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
    function updatePartItem(category, status, details = {}) {
      let item = document.getElementById(`part-${category}`);
      if (!item) {
        item = document.createElement('div');
        item.id = `part-${category}`;
        item.className = 'part-item';
        item.textContent = partNames[category] || category;
        partList.appendChild(item);
      }
      
      item.className = `part-item ${status}`;
      if (status === 'completed' && details.part_id) {
        item.textContent = `${partNames[category] || category} âœ“`;
        item.title = `${details.part_id} (score: ${details.score?.toFixed(3) || 'N/A'})`;
      } else if (status === 'skipped') {
        item.textContent = `${partNames[category] || category} âœ—`;
        item.title = `ã‚¹ã‚­ãƒƒãƒ—: ${details.reason || 'ç†ç”±ä¸æ˜'}`;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('image').files[0];
      if (!file) { alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      // å³æ™‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const localURL = URL.createObjectURL(file);
      result.innerHTML = `
        <div class="row">
          <div class="thumb">
            <img id="inputPreview" src="${localURL}" alt="input-local" />
            <div class="muted">å…¥åŠ›ç”»åƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
          </div>
        </div>
      `;

      btn.disabled = true;
      msg.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      statusContainer.style.display = 'block';
      statusContainer.className = 'status processing';
      currentStatus.textContent = 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      partList.innerHTML = '';
      prog.style.width = '20%';

      try {
        const fd = new FormData();
        fd.append('image', file);

        // /analyzeã«POSTã—ã¦stream_idã‚’å–å¾—
        const res = await fetch('/analyze', { method: 'POST', body: fd });
        const json = await res.json();
        
        if (!json.ok) throw new Error(json.error || 'failed');

        prog.style.width = '40%';
        currentStatus.textContent = 'åˆ†æä¸­...';

        // Server-Sent Eventsã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—å—ä¿¡
        const eventSource = new EventSource(`/stream/${json.stream_id}`);
        
        eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          console.log('SSE:', data);

          if (data.status === 'started') {
            currentStatus.textContent = 'åˆ†æé–‹å§‹ã—ã¾ã—ãŸ';
            prog.style.width = '50%';
          } else if (data.status === 'processing') {
            currentStatus.textContent = `${partNames[data.current_part] || data.current_part}ã‚’åˆ†æä¸­... (${data.progress}/${data.total})`;
            prog.style.width = `${50 + (data.percentage || 0) * 0.4}%`;
            updatePartItem(data.current_part, 'processing');
          } else if (data.status === 'completed') {
            updatePartItem(data.current_part, 'completed', data);
          } else if (data.status === 'skipped') {
            updatePartItem(data.current_part, 'skipped', data);
          } else if (data.status === 'composing') {
            currentStatus.textContent = 'ãƒ‘ãƒ¼ãƒ„åˆæˆã‚’å®Ÿè¡Œä¸­...';
            prog.style.width = '95%';
          } else if (data.status === 'finished') {
            // åˆ†æå®Œäº†
            eventSource.close();
            msg.textContent = 'å®Œäº†ï¼';
            prog.style.width = '100%';
            currentStatus.textContent = 'åˆ†æå®Œäº†';
            statusContainer.className = 'status completed';

            // åˆ†æçµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            analysisResult = data;

            // å…¥åŠ›ç”»åƒURLã‚’æ›´æ–°
            const prev = document.getElementById('inputPreview');
            if (prev && data.input_image_url) prev.src = data.input_image_url;

            // ãƒ‘ãƒ¼ãƒ„çµæœã‚’æç”»
            if (data.parts && data.parts.length > 0) {
              const row = document.createElement('div');
              row.className = 'row';
              data.parts.forEach(p => {
                const el = document.createElement('div');
                el.className = 'thumb';
                el.innerHTML = `
                  <img src="${p.image_url}" alt="${p.category}_${p.part_num}" />
                  <div class="muted">${partNames[p.category] || p.category} #${p.part_num} / score=${p.score.toFixed(3)}</div>
                `;
                row.appendChild(el);
              });
              result.appendChild(row);

              // åˆæˆç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
              if (data.composed_image_url) {
                const composedRow = document.createElement('div');
                composedRow.className = 'row';
                composedRow.style.marginTop = '24px';
                composedRow.innerHTML = `
                  <div class="thumb">
                    <img src="${data.composed_image_url}" alt="composed_result" style="width: 200px; height: 200px;" />
                    <div class="muted">åˆæˆçµæœ</div>
                    <button id="refine-btn" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">Geminiä¿®æ­£</button>
                  </div>
                `;
                result.appendChild(composedRow);
                
                // Geminiä¿®æ­£ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                const refineBtn = document.getElementById('refine-btn');
                refineBtn.addEventListener('click', async () => {
                  await refineWithGemini(data);
                });
              }

              if (data.raw_json_url) {
                const raw = document.createElement('div');
                raw.style.marginTop = '8px';
                raw.innerHTML = `
                  <a href="${data.raw_json_url}" target="_blank">JSONã‚’è¦‹ã‚‹</a>
                  <button id="iterative-btn" style="margin-left: 12px; padding: 6px 12px; background: #ff6b35; color: white;">ğŸ”„ åå¾©èª¿æ•´</button>
                `;
                result.appendChild(raw);
                
                // åå¾©èª¿æ•´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const iterativeBtn = document.getElementById('iterative-btn');
                iterativeBtn.addEventListener('click', async () => {
                  await startIterativeRefinement(data.raw_json_url);
                });
              }

              // åˆæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºãƒ»æœ‰åŠ¹åŒ–ï¼ˆãŸã ã—è‡ªå‹•åˆæˆã•ã‚ŒãŸå ´åˆã¯ä¸è¦ï¼‰
              if (!data.composed_image_url) {
                composeBtn.style.display = 'inline-block';
                composeBtn.disabled = false;
              }
            } else {
              currentStatus.textContent = 'åˆ†æå®Œäº†ï¼ˆè©²å½“ã™ã‚‹ãƒ‘ãƒ¼ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰';
            }

            btn.disabled = false;
            setTimeout(() => prog.style.width = '0%', 1200);
          } else if (data.status === 'error') {
            eventSource.close();
            throw new Error(data.error || 'å‡¦ç†ã‚¨ãƒ©ãƒ¼');
          }
        };

        eventSource.onerror = function() {
          eventSource.close();
          throw new Error('ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        };

      } catch (err) {
        console.error(err);
        msg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        currentStatus.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
        statusContainer.className = 'status error';
        prog.style.width = '0%';
        btn.disabled = false;
      }
    });

    // Geminiåº§æ¨™ä¿®æ­£é–¢æ•°
    async function refineWithGemini(analysisResult) {
      if (!analysisResult || !analysisResult.composed_image_url) {
        alert('åˆæˆç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const refineBtn = document.getElementById('refine-btn');
      if (refineBtn) {
        refineBtn.disabled = true;
        refineBtn.textContent = 'ä¿®æ­£ä¸­...';
      }

      try {
        const refineData = {
          composed_image_url: analysisResult.composed_image_url,
          raw_json_url: analysisResult.raw_json_url
        };
        
        console.log('[DEBUG] Sending refine data:', refineData);

        const response = await fetch('/refine', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(refineData)
        });

        const result = await response.json();

        if (result.ok) {
          // ä¿®æ­£çµæœã‚’è¡¨ç¤º
          const refinedRow = document.createElement('div');
          refinedRow.className = 'row';
          refinedRow.style.marginTop = '16px';
          refinedRow.innerHTML = `
            <div class="thumb" style="width: 300px;">
              <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; text-align: left; font-size: 12px; font-family: monospace;">
                <strong>Geminiä¿®æ­£çµæœ:</strong><br/>
                <pre>${JSON.stringify(result.refined_positions, null, 2)}</pre>
              </div>
              <div class="muted" style="margin-top: 8px;">
                <a href="${result.refinement_json_url}" target="_blank">ä¿®æ­£JSONã‚’è¦‹ã‚‹</a><br/>
                <button id="recompose-btn" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">ä¿®æ­£åº§æ¨™ã§å†åˆæˆ</button>
              </div>
            </div>
          `;
          
          // å†åˆæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          setTimeout(() => {
            const recomposeBtn = document.getElementById('recompose-btn');
            if (recomposeBtn) {
              recomposeBtn.addEventListener('click', async () => {
                await recomposeWithRefinedCoordinates(result.refinement_json_url);
              });
            }
          }, 100);
          
          // åˆæˆçµæœã®å¾Œã«è¿½åŠ 
          const composedRow = document.querySelector('.row:has(#refine-btn)');
          if (composedRow && composedRow.parentNode) {
            composedRow.parentNode.insertBefore(refinedRow, composedRow.nextSibling);
          } else {
            result.appendChild(refinedRow);
          }

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert('Geminiä¿®æ­£å®Œäº†ï¼ä¿®æ­£ã•ã‚ŒãŸåº§æ¨™æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚');
        } else {
          throw new Error(result.error || 'ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (err) {
        console.error('Geminiä¿®æ­£ã‚¨ãƒ©ãƒ¼:', err);
        alert(`ä¿®æ­£ã‚¨ãƒ©ãƒ¼: ${err.message}`);
      } finally {
        if (refineBtn) {
          refineBtn.disabled = false;
          refineBtn.textContent = 'Geminiä¿®æ­£';
        }
      }
    }

    // Geminiä¿®æ­£åº§æ¨™ã§ã®å†åˆæˆé–¢æ•°
    async function recomposeWithRefinedCoordinates(refinementJsonUrl) {
      const recomposeBtn = document.getElementById('recompose-btn');
      if (recomposeBtn) {
        recomposeBtn.disabled = true;
        recomposeBtn.textContent = 'å†åˆæˆä¸­...';
      }

      try {
        const recomposeData = {
          refinement_json_url: refinementJsonUrl
        };

        console.log('[DEBUG] Recomposing with refined coordinates:', recomposeData);

        const response = await fetch('/recompose', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(recomposeData)
        });

        const result = await response.json();

        if (result.ok) {
          // å†åˆæˆçµæœã‚’è¡¨ç¤º
          const recomposedRow = document.createElement('div');
          recomposedRow.className = 'row';
          recomposedRow.style.marginTop = '16px';
          recomposedRow.innerHTML = `
            <div class="thumb">
              <img src="${result.recomposed_image_url}" alt="recomposed_result" style="width: 200px; height: 200px;" />
              <div class="muted">Geminiä¿®æ­£å¾Œã®å†åˆæˆçµæœ</div>
            </div>
          `;

          // ä¿®æ­£çµæœã®å¾Œã«è¿½åŠ 
          const refinedRow = recomposeBtn.closest('.row');
          if (refinedRow && refinedRow.parentNode) {
            refinedRow.parentNode.insertBefore(recomposedRow, refinedRow.nextSibling);
          } else {
            result.appendChild(recomposedRow);
          }

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert('ä¿®æ­£ã•ã‚ŒãŸåº§æ¨™ã§ã®å†åˆæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        } else {
          throw new Error(result.error || 'å†åˆæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (err) {
        console.error('å†åˆæˆã‚¨ãƒ©ãƒ¼:', err);
        alert(`å†åˆæˆã‚¨ãƒ©ãƒ¼: ${err.message}`);
      } finally {
        if (recomposeBtn) {
          recomposeBtn.disabled = false;
          recomposeBtn.textContent = 'ä¿®æ­£åº§æ¨™ã§å†åˆæˆ';
        }
      }
    }

    // åå¾©èª¿æ•´æ©Ÿèƒ½
    async function startIterativeRefinement(rawJsonUrl) {
      const iterativeBtn = document.getElementById('iterative-btn');
      if (iterativeBtn) {
        iterativeBtn.disabled = true;
        iterativeBtn.textContent = 'ğŸ”„ èª¿æ•´ä¸­...';
      }

      // åå¾©èª¿æ•´å°‚ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
      const iterativeContainer = document.createElement('div');
      iterativeContainer.className = 'card';
      iterativeContainer.style.marginTop = '24px';
      iterativeContainer.innerHTML = `
        <h3>ğŸ”„ åå¾©çš„ãƒ‘ãƒ¼ãƒ„èª¿æ•´</h3>
        <div class="status processing" id="iterative-status">
          <div id="iterative-current">èª¿æ•´ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</div>
          <div class="bar"><div id="iterative-prog"></div></div>
        </div>
        <div id="iteration-gallery" class="row" style="margin-top: 16px;"></div>
      `;
      
      document.body.appendChild(iterativeContainer);

      try {
        // åå¾©èª¿æ•´é–‹å§‹
        const response = await fetch('/iterative_refine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ raw_json_url: rawJsonUrl })
        });

        const result = await response.json();
        if (!result.ok) throw new Error(result.error);

        // SSEã§é€²æ—ç›£è¦–
        const eventSource = new EventSource(`/stream/${result.stream_id}`);
        
        eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          console.log('åå¾©SSE:', data);

          const iterativeStatus = document.getElementById('iterative-status');
          const iterativeCurrent = document.getElementById('iterative-current');
          const iterativeProg = document.getElementById('iterative-prog');
          const iterationGallery = document.getElementById('iteration-gallery');

          if (data.status === 'started') {
            iterativeCurrent.textContent = `åå¾©èª¿æ•´é–‹å§‹ï¼ˆ${data.parts.join(', ')}ï¼‰`;
            iterativeProg.style.width = '10%';
          } 
          
          else if (data.status === 'composing') {
            iterativeCurrent.textContent = data.message;
            iterativeProg.style.width = `${10 + (data.iteration * 15)}%`;
          } 
          
          else if (data.status === 'iteration_image') {
            // åå¾©ç”»åƒã‚’è¡¨ç¤º
            const iterationThumb = document.createElement('div');
            iterationThumb.className = 'thumb';
            iterationThumb.innerHTML = `
              <img src="${data.image_url}" alt="iteration_${data.iteration}" style="width: 120px; height: 120px;" />
              <div class="muted">åå¾© ${data.iteration}</div>
            `;
            iterationGallery.appendChild(iterationThumb);
            
            iterativeCurrent.textContent = `åå¾© ${data.iteration}: ç”»åƒç”Ÿæˆå®Œäº†`;
          } 
          
          else if (data.status === 'analyzing') {
            iterativeCurrent.textContent = data.message;
            iterativeProg.style.width = `${15 + (data.iteration * 15)}%`;
          } 
          
          else if (data.status === 'adjustment_result') {
            if (data.satisfied) {
              iterativeCurrent.textContent = `åå¾© ${data.iteration}: æº€è¶³ï¼ - ${data.notes}`;
            } else {
              const adjText = Object.entries(data.adjustments).map(([part, adj]) => 
                `${part}(${adj.position || ''}${adj.scale ? '/' + adj.scale : ''})`
              ).join(', ');
              iterativeCurrent.textContent = `åå¾© ${data.iteration}: ${adjText} - ${data.notes}`;
            }
          } 
          
          else if (data.status === 'finished') {
            eventSource.close();
            iterativeStatus.className = 'status completed';
            iterativeCurrent.textContent = data.message;
            iterativeProg.style.width = '100%';
            
            // æœ€çµ‚çµæœã‚’è¡¨ç¤º
            if (data.final_image_url) {
              const finalThumb = document.createElement('div');
              finalThumb.className = 'thumb';
              finalThumb.style.border = '3px solid #4caf50';
              finalThumb.innerHTML = `
                <img src="${data.final_image_url}" alt="final_result" style="width: 160px; height: 160px;" />
                <div class="muted"><strong>æœ€çµ‚çµæœ</strong></div>
              `;
              iterationGallery.appendChild(finalThumb);
            }
            
            alert(`åå¾©èª¿æ•´å®Œäº†ï¼${data.iteration}å›ã®èª¿æ•´ã§æœ€é©åŒ–ã•ã‚Œã¾ã—ãŸã€‚`);
          } 
          
          else if (data.status === 'error') {
            eventSource.close();
            iterativeStatus.className = 'status error';
            iterativeCurrent.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error}`;
            throw new Error(data.error);
          }
        };

        eventSource.onerror = function() {
          eventSource.close();
          throw new Error('ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        };

      } catch (err) {
        console.error('åå¾©èª¿æ•´ã‚¨ãƒ©ãƒ¼:', err);
        alert(`åå¾©èª¿æ•´ã‚¨ãƒ©ãƒ¼: ${err.message}`);
      } finally {
        if (iterativeBtn) {
          iterativeBtn.disabled = false;
          iterativeBtn.textContent = 'ğŸ”„ åå¾©èª¿æ•´';
        }
      }
    }

    // åˆæˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    composeBtn.addEventListener('click', async () => {
      if (!analysisResult || !analysisResult.parts) {
        alert('åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      composeBtn.disabled = true;
      composeBtn.textContent = 'åˆæˆä¸­...';

      try {
        const composeData = {
          input_image_url: analysisResult.input_image_url,
          parts: analysisResult.parts
        };

        const response = await fetch('/compose', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(composeData)
        });

        const result = await response.json();

        if (result.ok) {
          // åˆæˆçµæœã‚’è¡¨ç¤º
          const composedRow = document.createElement('div');
          composedRow.className = 'row';
          composedRow.style.marginTop = '20px';
          composedRow.innerHTML = `
            <div style="width: 100%; text-align: center;">
              <h3>åˆæˆçµæœ</h3>
              <img src="${result.composed_image_url}" alt="åˆæˆçµæœ" style="max-width: 400px; border: 2px solid #4caf50; border-radius: 8px;" />
            </div>
          `;
          result.appendChild(composedRow);

          composeBtn.textContent = 'åˆæˆå®Œäº†';
        } else {
          throw new Error(result.error || 'åˆæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('åˆæˆã‚¨ãƒ©ãƒ¼:', error);
        alert(`åˆæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
        composeBtn.textContent = 'ãƒ‘ãƒ¼ãƒ„ã‚’åˆæˆã™ã‚‹';
      } finally {
        composeBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
